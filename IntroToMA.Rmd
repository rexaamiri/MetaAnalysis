---
author: Mohammadreza Amiri, BA, MSc, PhD
date: '2021-10-26'
title: An Introduction to Meta-Analysis with R
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
    number_sections: true
    toc: true
    #toc_float: true
    toc_depth: 2.0
toc-title: "Outline"
fontsize: 10pt
citecolor: blue
urlcolor: red
bibliography: references.bib
biblio-title: References
csl: apa.csl
link-citations: true
---

```{r setup, include=FALSE}
library(knitr)

# Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
knitr::opts_chunk$set(echo = TRUE)
```

# Making Everything Ready

Visit this [link](https://learnr-examples.shinyapps.io/ex-setup-r/ "To setup R, RStudio IDE, and guide to install packages") to find out how to install R, RStudio IDE, and install R packages.

## R

R is a free software environment for statistical computing and graphics. R software can be downloaded [here](https://www.r-project.org/). The most recent version of R is 4.1.1 (Kick Things) and has been released on 2021-08-10. However, some packages that I frequently use do not support the newest version of R. Facilitating this issue, I use version 3.6.3 on my system.

Nonetheless, you are able to install and use multiple version of R on your system and using RStudio you can switch back and forth to any version of R based on your needs.

To get help using R access their webpage [here](https://www.r-project.org/help.html).

## RStudio

RStudio's mission is to create free and open-source software for data science, scientific research, and technical communication. Inspired by innovators in science, education, government, and industry, RStudio develops free and open tools for R, and enterprise-ready professional products for teams who use both R and Python, to scale and share their work. RStudio Integrated development environment (IDE) can be downloaded [here](https://www.rstudio.com/products/rstudio/download/). We are using RStudio for this workshop.

# What is a meta-analysis (MA)?

## Definition

The following definitions summarize the MA statistical technique:

> "Analysis of analyses" [@glass1976]

> "Meta-analysis can be understood as a form of survey research in which research reports, rather than people, are surveyed." [@lipsey2001]

# Best packages to conduct a MA

The best packages are:

# Data Preparation

Loading required packages (don't forget to install the packages first if you have not done so):

```{r packages, include=FALSE}
# install.package("tidyverse", "metafor")
library(tidyverse)
library(metafor)
```

Let's view the data for this session:

```{r data-load}
dat <- dat.bcg

knitr::kable(dat)
```

Now we need to calculate the log risk ratios and corresponding sampling variances (and use the 'slab' argument to store study labels as part of the data frame):

```{r data-preparation}
dat <- escalc(measure="RR", 
              ai=tpos, 
              bi=tneg, 
              ci=cpos, 
              di=cneg, 
              data=dat,
              slab=paste(author, year, sep=", "))

dat %>% 
    select(trial, author, year, yi, vi) %>% 
    knitr::kable()
```

Effect size (*yi*): Log(RR)

Standard error of effect size (*vi*): Standard Error Log(RR)

# Hands-on practice

```{r forest-plot}

# Fitting a random-effects model
res <- rma(yi, vi, data=dat)
 

# Forest plot combined with (necessary) annotations
forest(res, atransf=exp, at=log(c(.05, .25, 1, 4)), xlim=c(-16,6),
       ilab=cbind(dat.bcg$tpos, dat.bcg$tneg, dat.bcg$cpos, dat.bcg$cneg),
       ilab.xpos=c(-9.5,-8,-6,-4.5), cex=.75, header="Author(s) and Year",
       mlab="")

op <- par(cex=.75, font=2)

text(c(-9.5,-8,-6,-4.5), 15, c("TB+", "TB-", "TB+", "TB-"))

text(c(-8.75,-5.25),     16, c("Vaccinated", "Control"))

par(op)
 

# add text with Q-value, dfs, p-value, and I^2 statistic
text(-16, -1, pos=4, cex=0.75, 
     bquote(paste("RE Model (Q = ", .(formatC(res$QE, digits=2, format="f")), 
                  ", df = ", .(res$k - res$p), ", p = ",
                  .(formatC(res$QEp, digits=2, format="f")),
                  "; ", I^2, " = ", .(formatC(res$I2, digits=1, format="f")),
                  "%)")))
```

# References
